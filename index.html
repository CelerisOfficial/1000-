const API_URL = "https://script.google.com/macros/s/AKfycbzbpiIWax0ccfefIX8G42HTKqvS1UNKL1TGfEB91mMimyBlOvarFVlhnIrL4Web9vxsvw/exec";

// Kullanıcıyı Google'dan aldıktan sonra kaydet
async function saveUserToSheet(user) {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      sub: user.sub,
      name: user.name,
      email: user.email
    })
  });

  const result = await res.json();
  console.log("Kayıt sonucu:", result);
  if (result.success) {
    showSuccessUI();
  }
}

// Tüm kullanıcıları çek
async function fetchUsersFromSheet() {
  const res = await fetch(API_URL);
  const users = await res.json();
  console.log("Kayıtlı kullanıcılar:", users);
  updateUsersTable(users);
}

// Tabloya kullanıcıları yaz
function updateUsersTable(users) {
  const table = document.getElementById("userTable");
  table.innerHTML = ""; // temizle

  users.forEach((user, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${user.name}</td>
      <td>${user.email}</td>
    `;
    table.appendChild(row);
  });

  // Barı güncelle
  document.getElementById("userCount").innerText = `${users.length}/1000`;
}

function handleCredentialResponse(response) {
  const userInfo = jwt_decode(response.credential);
  const user = {
    sub: userInfo.sub,
    name: userInfo.name,
    email: userInfo.email
  };

  saveUserToSheet(user).then(fetchUsersFromSheet);
}

function showSuccessUI() {
  const message = document.createElement("div");
  message.innerText = "✅ Kayıt başarılı!";
  message.style.marginTop = "20px";
  message.style.fontSize = "18px";
  message.style.color = "green";
  document.body.insertBefore(message, document.getElementById("userTable").parentNode);
}

window.onload = () => {
  fetchUsersFromSheet();
};
