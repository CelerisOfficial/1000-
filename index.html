<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Google Giriş + Kayıt</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  body { font-family: Arial; padding: 20px; }
  #user-info { margin-top: 20px; }
  #registerDiv { display:none; margin-top: 20px; }
  input { padding: 5px; }
</style>

</head>
<body>

<h2>Google ile Giriş Yap</h2>
<div id="g_id_onload"
     data-client_id="537474382538-bp4g5n0ute985jq2qs2lbestg82cgid5.apps.googleusercontent.com"
     data-callback="handleCredentialResponse">
</div>

<div class="g_id_signin" data-type="standard"></div>

<div id="user-info"></div>

<div id="registerDiv">
  <h3>Adını Yaz</h3>
  <input type="text" id="nameInput" placeholder="Adın..." />
  <button id="saveNameBtn">Kaydet</button>
  <p id="message" style="color:red;"></p>
</div>

<script>
// Giriş yapan kullanıcının bilgisi saklanacak
let user = null;
let hasRegistered = false;

function handleCredentialResponse(response) {
  // Google'dan JWT token geliyor ama biz basit demo yapıyoruz
  // decodeJwt kısmı token'dan isim alma fonksiyonu
  const data = parseJwt(response.credential);
  user = data;

  document.getElementById('user-info').innerHTML = `
    <p><b>Hoşgeldin, ${user.name}</b> (${user.email})</p>
  `;

  // Daha önce kayıt yaptı mı?
  if (localStorage.getItem('registered_'+user.sub)) {
    hasRegistered = true;
    document.getElementById('registerDiv').style.display = 'none';
    document.getElementById('message').textContent = 'Zaten kayıt oldun!';
  } else {
    document.getElementById('registerDiv').style.display = 'block';
  }
}

document.getElementById('saveNameBtn').addEventListener('click', () => {
  const name = document.getElementById('nameInput').value.trim();
  if (!name) {
    document.getElementById('message').textContent = 'Lütfen adını gir!';
    return;
  }
  // Kayıt yapıldı diye localStorage kaydet
  localStorage.setItem('registered_' + user.sub, name);
  hasRegistered = true;
  document.getElementById('message').style.color = 'green';
  document.getElementById('message').textContent = 'Kayıt başarılı!';
  document.getElementById('registerDiv').style.display = 'none';
});

// JWT token'ı decode et
function parseJwt(token) {
  var base64Url = token.split('.')[1];
  var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));

  return JSON.parse(jsonPayload);
}
</script>

</body>
</html>
