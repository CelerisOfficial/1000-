<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Google Giriş + Kayıt Tablosu</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  body { font-family: Arial; padding: 20px; }
  #user-info { margin-top: 20px; }
  #registerDiv { display:none; margin-top: 20px; }
  input { padding: 5px; }
  table { border-collapse: collapse; margin-top: 20px; width: 100%; max-width: 400px; }
  th, td { border: 1px solid #999; padding: 8px; text-align: left; }
  #countBar { margin-top: 10px; font-weight: bold; }
</style>

</head>
<body>

<h2>Google ile Giriş Yap</h2>
<div id="g_id_onload"
     data-client_id="537474382538-bp4g5n0ute985jq2qs2lbestg82cgid5.apps.googleusercontent.com"
     data-callback="handleCredentialResponse">
</div>

<div class="g_id_signin" data-type="standard"></div>

<div id="user-info"></div>

<div id="registerDiv">
  <h3>Adını Yaz</h3>
  <input type="text" id="nameInput" placeholder="Adın..." />
  <button id="saveNameBtn">Kaydet</button>
  <p id="message" style="color:red;"></p>
</div>

<h3>Kayıtlı Kullanıcılar</h3>
<div id="countBar">0 / 1000 kişi kayıt oldu</div>
<table id="usersTable">
  <thead>
    <tr><th>Ad</th><th>Email</th></tr>
  </thead>
  <tbody>
  </tbody>
</table>

<script>
let user = null;

// localStorage'da kayıtlar usersList olarak JSON dizisi tutulacak
// format: [{sub, name, email}]

// Helper: Kayıtlı kullanıcıları getir
function getUsersList() {
  const data = localStorage.getItem('usersList');
  return data ? JSON.parse(data) : [];
}

// Helper: Kayıtlı kullanıcıları kaydet
function setUsersList(list) {
  localStorage.setItem('usersList', JSON.stringify(list));
}

// Kullanıcı zaten kayıtlı mı kontrol et
function isUserRegistered(sub) {
  return getUsersList().some(u => u.sub === sub);
}

// Kayıtlı kullanıcı bilgilerini getir
function getUserInfo(sub) {
  return getUsersList().find(u => u.sub === sub);
}

// Tabloyu güncelle
function updateUsersTable() {
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = ''; // temizle
  const users = getUsersList();
  users.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.name}</td><td>${u.email}</td>`;
    tbody.appendChild(tr);
  });
  // Sayaç güncelle
  document.getElementById('countBar').textContent = `${users.length} / 1000 kişi kayıt oldu`;
}

// Google'dan gelen credential'ı çöz
function parseJwt(token) {
  var base64Url = token.split('.')[1];
  var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
  return JSON.parse(jsonPayload);
}

// Google giriş yapınca
function handleCredentialResponse(response) {
  const data = parseJwt(response.credential);
  user = data;

  document.getElementById('user-info').innerHTML = `
    <p><b>Hoşgeldin, ${user.name}</b> (${user.email})</p>
  `;

  if (isUserRegistered(user.sub)) {
    // Kayıtlı ise isim inputunu gizle
    document.getElementById('registerDiv').style.display = 'none';
    document.getElementById('message').style.color = 'green';
    document.getElementById('message').textContent = 'Zaten kayıtlısın!';
  } else {
    // Kayıtlı değilse input göster
    document.getElementById('registerDiv').style.display = 'block';
    document.getElementById('message').textContent = '';
  }
  updateUsersTable();
}

// Kayıt butonuna basınca
document.getElementById('saveNameBtn').addEventListener('click', () => {
  const nameInput = document.getElementById('nameInput');
  const name = nameInput.value.trim();
  const message = document.getElementById('message');

  if (!name) {
    message.style.color = 'red';
    message.textContent = 'Lütfen bir isim gir!';
    return;
  }

  if (!user) {
    message.style.color = 'red';
    message.textContent = 'Önce Google ile giriş yapmalısın!';
    return;
  }

  if (isUserRegistered(user.sub)) {
    message.style.color = 'red';
    message.textContent = 'Zaten kayıtlısın!';
    return;
  }

  // Yeni kullanıcıyı kaydet
  const users = getUsersList();
  users.push({sub: user.sub, name: name, email: user.email});
  setUsersList(users);

  message.style.color = 'green';
  message.textContent = 'Kayıt başarılı!';

  // Inputu gizle
  document.getElementById('registerDiv').style.display = 'none';

  updateUsersTable();
});

// Sayfa yüklendiğinde eğer daha önce giriş yapılmışsa kullanıcıyı otomatik tanı
window.onload = () => {
  const users = getUsersList();

  // localStorage'da login bilgisi yok, yapacak bir şey yok
  // Bu örnekte tokeni saklamıyoruz, ama kullanıcı adını saklıyoruz (isim kayıt için)
  // O yüzden sayfa yenilendiğinde kullanıcıyı tanıyamıyoruz,
  // gerçek projede Firebase veya backend lazım.

  updateUsersTable();
};
</script>

</body>
</html>
